<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>908 è‹±é›„è¯ç›Ÿæˆ°åŠ›ç®¡ç†ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #020617; --card: rgba(30, 41, 59, 0.8); 
            --accent: #22d3ee; --gold: #fbbf24; --text: #f8fafc; 
            --xp: #8b5cf6; --danger: #f43f5e; --success: #4ade80;
            --rank-bg: rgba(15, 23, 42, 0.6);
        }
        
        body { 
            background: radial-gradient(circle at top, #1e293b 0%, #020617 100%); 
            color: var(--text); font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin: 0; padding-bottom: 60px; overflow-x: hidden;
            font-size: 0.95rem; 
        }

        .container { width: 92%; max-width: 680px; margin: auto; padding: 10px; }

        .hero-title { 
            font-size: 2.2rem; 
            font-weight: 900; 
            text-align: center; 
            margin-top: 2vh;
            background: linear-gradient(to right, #fff, var(--accent), #fff);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            animation: glowText 3s infinite;
            line-height: 1.1;
        }

        .hero-subtitle {
            display: block;
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 400;
            margin-top: 10px;
            letter-spacing: 1px;
            background: none;
            -webkit-text-fill-color: #94a3b8;
        }

        @keyframes glowText { 0%, 100% { filter: drop-shadow(0 0 5px rgba(34,211,238,0.3)); } 50% { filter: drop-shadow(0 0 15px rgba(34,211,238,0.6)); } }

        .card { 
            background: var(--card); backdrop-filter: blur(15px); padding: 22px; border-radius: 28px; 
            border: 1px solid rgba(255,255,255,0.1); margin-top: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); animation: cardSlide 0.6s ease-out;
        }
        @keyframes cardSlide { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h3 { font-size: 1.2rem; color: var(--gold); margin: 0 0 15px 0; border-left: 4px solid var(--accent); padding-left: 10px; }
        
        .rank-dashboard {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-bottom: 20px; background: var(--rank-bg); padding: 15px;
            border-radius: 18px; border: 1px solid rgba(34, 211, 238, 0.3);
        }
        .rank-box { text-align: center; border-right: 1px solid rgba(255,255,255,0.1); }
        .rank-box:last-child { border-right: none; }
        .rank-label { font-size: 0.7rem; color: var(--accent); font-weight: bold; text-transform: uppercase; }
        .rank-value { font-size: 1.4rem; color: var(--gold); font-weight: 900; margin-top: 5px; }
        .rank-unit { font-size: 0.7rem; color: #64748b; margin-left: 2px; }

        select, input { 
            width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 2px solid #334155; 
            background: rgba(15, 23, 42, 0.9); color: white; font-size: 1rem; box-sizing: border-box;
        }
        .main-btn { 
            width: 100%; padding: 16px; background: linear-gradient(135deg, #0ea5e9, #22d3ee); 
            border: none; border-radius: 14px; color: #0f172a; font-size: 1.1rem; font-weight: 800; 
            cursor: pointer; transition: 0.3s;
        }
        .main-btn:active { transform: scale(0.97); }

        .hero-icon { font-size: 4rem; animation: float 3s infinite ease-in-out; display: block; margin: auto; text-align: center; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .side-box { padding: 12px; border-radius: 14px; font-size: 0.85rem; line-height: 1.5; border: 1px solid rgba(255,255,255,0.1); }
        .strength-msg { border-left: 4px solid var(--success); background: rgba(74, 222, 128, 0.1); }
        .weakness-msg { border-left: 4px solid var(--danger); background: rgba(244, 63, 94, 0.1); }

        @media (max-width: 480px) { .hero-title { font-size: 1.8rem; } }
    </style>
</head>
<body>

<div class="container">
    <div id="loginWrapper">
        <div class="hero-icon">ğŸ›¡ï¸</div>
        <h1 class="hero-title">
            908 è‹±é›„è¯ç›Ÿæˆ°åŠ›ç®¡ç†ç³»çµ±
            <span class="hero-subtitle">V1.5 2026 JAE Plan</span>
        </h1>

        <div class="card">
            <h3>ç³»çµ±ç™»å…¥</h3>
            <select id="userSelect"><option value="">-- è«‹é¸æ“‡åº§è™Ÿ --</option></select>
            <input type="password" id="userPass" placeholder="è¼¸å…¥ 6 ä½è‹±é›„é‡‘é‘°">
            <button class="main-btn" onclick="handleLogin()">é€²å…¥ç³»çµ±</button>
            <div style="margin-top: 15px; text-align: center;">
                <button onclick="adminResetPrompt()" style="background: none; border: none; color: #475569; font-size: 0.8rem; text-decoration: underline; cursor: pointer;">ç®¡ç†å“¡å…¥å£ (ç³»çµ±è¨­å®š)</button>
            </div>
        </div>
    </div>

    <div id="reportSection" style="display:none;">
        <div class="card" style="text-align: center;">
            <div id="heroEmoji" style="font-size: 3.5rem; margin-bottom: 5px;">ğŸ–ï¸</div>
            <h2 id="displayName" style="font-size: 2rem; margin: 0;">--</h2>
            <div id="heroRank" style="color:var(--accent); font-size: 1.2rem; font-weight:900; letter-spacing: 2px; line-height: 1.4;">--</div>
            <div id="rankGapInfo" style="margin-top: 8px; font-size: 0.85rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;"></div>
        </div>

        <div class="card">
            <div class="rank-dashboard">
                <div class="rank-box">
                    <div class="rank-label">Class ç­æ’</div>
                    <div class="rank-value" id="val_v">--</div>
                </div>
                <div class="rank-box">
                    <div class="rank-label">School æ ¡æ’</div>
                    <div class="rank-value" id="val_y">--</div>
                </div>
                <div class="rank-box">
                    <div class="rank-label">Dist å€æ’</div>
                    <div class="rank-value" id="val_ab">--</div>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="color:var(--accent); font-weight:bold; font-size:1rem;">âš”ï¸ æˆ°åŠ›é‡å°º (æ»¿åˆ†45ç´šåˆ†)</span>
                <span id="xpLabel" style="color:var(--gold); font-weight:900; font-size:1.1rem;">0 / 45</span>
            </div>
            
            <div style="position: relative; margin-top: 10px; padding-bottom: 25px;">
                <div style="height:24px; background:#1e293b; border-radius:12px; overflow:hidden; position: relative; z-index: 1;">
                    <div id="xpBarFill" style="height:100%; width:0%; background:linear-gradient(90deg, var(--xp), var(--accent)); transition: 1.2s ease-out;"></div>
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; pointer-events: none; padding: 0 1px; box-sizing: border-box;">
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.2); height: 100%;"></div>
                    </div>
                </div>
                <div style="position: absolute; width: 100%; left: 0; margin-top: 5px; display: flex; justify-content: space-between; padding: 0 1px; box-sizing: border-box;">
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">0</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">5</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">10</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">15</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">20</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">25</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">30</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">35</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">40</span>
                    <span style="color: #64748b; font-size: 0.65rem; width: 0; text-align: center; overflow: visible;">45</span>
                </div>
            </div>

            <div id="gradeBadges" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:18px; justify-content:center;"></div>
        </div>

        <div class="card">
            <h3>ğŸ“ˆ æˆ°åŠ›æˆé•·è¶¨å‹¢ (æ­·æ¬¡æ¨¡æ“¬è€ƒ)</h3>
            <div style="height: 250px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap;">
                <div style="flex:1.2; min-width:260px; height:240px;">
                    <canvas id="radarChart"></canvas>
                </div>
                <div style="flex:1; min-width:200px; display:flex; flex-direction:column; gap:12px;">
                    <div id="strengthBox" class="side-box strength-msg">--</div>
                    <div id="weaknessBox" class="side-box weakness-msg">--</div>
                </div>
            </div>
        </div>

        <div class="card" style="border: 1.5px dashed var(--accent);">
            <h3>âš¡ æˆå°±è§£é– (è¼¸å…¥æ–°ç©åˆ†) </h3>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;" id="gradeInputs"></div>
            <div style="margin-top: 10px;">
                <small style="color:var(--gold); font-weight:bold;">ğŸ“ æœ¬æ¬¡æ¨¡æ“¬è€ƒå€æ’</small>
                <input type="number" id="in_distRank" placeholder="è«‹è¼¸å…¥å€æ’æ¬¡">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="main-btn" style="font-size: 0.85rem;" onclick="syncAndAnalyze()">åŒæ­¥åˆ†ææ•¸æ“š</button>
                <button class="main-btn" style="background:rgba(255,255,255,0.1); color:white; border:1px solid #475569; font-size: 0.85rem;" onclick="resetInputsToCurrent()">ğŸ§¹ æ¸…é™¤/æ¢å¾©é è¨­</button>
            </div>
            <button class="main-btn" style="margin-top:10px; background:var(--gold); color:#000;" onclick="saveCurrentRecord()">ğŸ’¡ å°‡æ­¤æˆç¸¾å­˜ç‚ºæ­£å¼æˆ°å ±</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; border-left: 4px solid var(--accent); padding-left: 10px;">ğŸ“‚ æˆ°å ±å­˜æª”</h3>
                <button onclick="clearAllHistory()" style="background:rgba(244,63,94,0.1); border:1px solid var(--danger); color:var(--danger); padding:5px 12px; border-radius:10px; cursor:pointer; font-size:0.8rem; font-weight:bold; border: 1px solid var(--danger);"> å…¨éƒ¨æ¸…é™¤</button>
            </div>
            <div id="historyList"></div>
        </div>

        <div class="card">
            <h3>ğŸ“ ç›®å‰å·²é–‹ç™¼åœ°åœ–</h3>
            <div id="targetList"></div>
            <div id="finalScoreLabel" style="text-align: right; margin-top: 10px; font-weight: 900; color: var(--accent); font-size: 1.1rem;">--</div>
        </div>

        <div class="card">
            <h3>ğŸ—“ï¸ å»ºè­°ä¿®ç…‰é€±è¡¨ </h3>
            <div style="overflow-x: auto;">
                <table style="width:100%; font-size: 0.9rem; text-align: center;">
                    <thead><tr><th>ç§‘ç›®</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr></thead>
                    <tbody id="cramSetupBody"></tbody>
                </table>
            </div>
            <button class="main-btn" style="background:var(--xp); color:white; margin-top:15px;" onclick="generateWeeklySchedule()">é‡æ–°éƒ¨ç½²è¨ˆç•«</button>
            <div style="overflow-x: auto; margin-top: 15px;">
                <table class="schedule-table" style="width:100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px;">
                    <thead><tr><th>æ™‚æ®µ</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th></tr></thead>
                    <tbody id="weeklyBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--danger);">
            <button class="main-btn" style="background:transparent; border:2px solid var(--danger); color:var(--danger);" onclick="location.reload()">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<script>
    const heroKeys = {
        "1":"582491","2":"193758","3":"620485","4":"847129","5":"319506",
        "6":"702843","7":"461937","8":"258074","9":"936215","10":"104862",
        "11":"675129","12":"829403","13":"390571","14":"518246","15":"746390",
        "16":"285107","17":"953684","18":"402751","19":"631928","20":"874052",
        "21":"129364","22":"560417","23":"387190","24":"715243","25":"492085",
        "26":"903176","27":"268419","28":"537092","29":"814620","30":"159384",
        "admin":"908admin"
    };

    const db = [
        {id:1, name:"ç‹æ˜±å¡", v:12, w:227, x:2065, g:{ch:"B+", en:"B", ma:"B++", sc:"B++", so:"A", wr:"4"}},
        {id:2, name:"å³å½¥å‹³", v:15, w:299, x:3006, g:{ch:"B+", en:"B", ma:"A", sc:"B+", so:"B", wr:"3"}},
        {id:3, name:"æè‡´è«­", v:20, w:351, x:3751, g:{ch:"B", en:"C", ma:"A", sc:"B", so:"B+", wr:"4"}},
        {id:4, name:"ææ™‰å®‰", v:25, w:419, x:5056, g:{ch:"B", en:"C", ma:"B+", sc:"B", so:"B", wr:"3"}},
        {id:5, name:"æ²ˆå®å½¥", v:10, w:142, x:1250, g:{ch:"A+", en:"B", ma:"A+", sc:"B+", so:"A", wr:"4"}},
        {id:6, name:"å¼µäºå®—", v:26, w:427, x:5326, g:{ch:"C", en:"B", ma:"B+", sc:"B", so:"B", wr:"2"}},
        {id:7, name:"æ¢æ¾„ç¥", v:27, w:460, x:6423, g:{ch:"B", en:"C", ma:"C", sc:"B", so:"B", wr:"4"}},
        {id:8, name:"é™³å®¥äºˆ", v:29, w:499, x:7712, g:{ch:"C", en:"C", ma:"C", sc:"C", so:"C", wr:"3"}},
        {id:9, name:"é™³ç¥å‘ˆ", v:7, w:94, x:757, g:{ch:"A+", en:"A+", ma:"B++", sc:"B++", so:"B++", wr:"4"}},
        {id:10, name:"é™³ç¿å®", v:21, w:354, x:3800, g:{ch:"B+", en:"B+", ma:"A+", sc:"B++", so:"B++", wr:"3"}},
        {id:11, name:"é»ƒç…’å‡±", v:14, w:297, x:2988, g:{ch:"B++", en:"B", ma:"B+", sc:"B+", so:"B", wr:"3"}},
        {id:12, name:"é»ƒå³»å”¯", v:6, w:67, x:468, g:{ch:"A++", en:"B+", ma:"A", sc:"A", so:"A+", wr:"4"}},
        {id:13, name:"æ¥Šçš“å®‡", v:22, w:358, x:3865, g:{ch:"B", en:"B", ma:"B+", sc:"B", so:"B++", wr:"4"}},
        {id:14, name:"åŠ‰ä¸æ©", v:28, w:463, x:6492, g:{ch:"B", en:"C", ma:"B", sc:"C", so:"B", wr:"3"}},
        {id:15, name:"åŠ‰å®¥æ‰¿", v:11, w:148, x:1325, g:{ch:"B++", en:"B++", ma:"A", sc:"B++", so:"B++", wr:"4"}},
        {id:16, name:"åŠ‰ç…¥é¨°", v:2, w:40, x:232, g:{ch:"A++", en:"B++", ma:"A", sc:"A+", so:"A++", wr:"4"}},
        {id:17, name:"æ´ªæ¹˜èŠ¸", v:13, w:234, x:2191, g:{ch:"B++", en:"B+", ma:"C", sc:"B+", so:"A+", wr:"4"}},
        {id:18, name:"èƒ¡èªå½¤", v:16, w:303, x:3117, g:{ch:"B", en:"B+", ma:"B++", sc:"B++", so:"B", wr:"2"}},
        {id:19, name:"å¼µæ™ç¿", v:17, w:329, x:3352, g:{ch:"B+", en:"B", ma:"B", sc:"B++", so:"B+", wr:"3"}},
        {id:20, name:"å¼µå‡±è–°", v:23, w:365, x:3981, g:{ch:"B", en:"B+", ma:"B+", sc:"B++", so:"B", wr:"4"}},
        {id:21, name:"è¨±æ™¶è", v:18, w:333, x:3372, g:{ch:"B+", en:"C", ma:"B+", sc:"B++", so:"B+", wr:"3"}},
        {id:22, name:"é»ƒç­±è", v:3, w:54, x:357, g:{ch:"A+", en:"B+", ma:"B++", sc:"A+", so:"A++", wr:"4"}},
        {id:23, name:"é»ƒå¿ƒæ¸", v:9, w:133, x:1126, g:{ch:"B++", en:"B+", ma:"A++", sc:"B++", so:"B++", wr:"4"}},
        {id:24, name:"ç«¥è‹¥ç‘„", v:5, w:59, x:393, g:{ch:"A+", en:"A", ma:"A+", sc:"A", so:"A++", wr:"4"}},
        {id:25, name:"é»ƒå¯€è¡", v:29, w:499, x:7712, g:{ch:"C", en:"C", ma:"C", sc:"C", so:"C", wr:"3"}},
        {id:26, name:"è©¹æ²›ç’‡", v:19, w:339, x:3502, g:{ch:"B", en:"B+", ma:"B+", sc:"B", so:"B", wr:"4"}},
        {id:27, name:"å»–å©•å¦¤", v:24, w:412, x:4886, g:{ch:"B", en:"B", ma:"B", sc:"B", so:"B", wr:"3"}},
        {id:28, name:"åŠ‰èŠ®ç‘œ", v:4, w:55, x:363, g:{ch:"A++", en:"B++", ma:"A", sc:"A", so:"A", wr:"4"}},
        {id:29, name:"æ½˜æ›‰éš", v:8, w:109, x:908, g:{ch:"A+", en:"A", ma:"B++", sc:"A", so:"B++", wr:"4"}},
        {id:30, name:"è¬æ²›ç’‡", v:1, w:29, x:99, g:{ch:"A++", en:"A+", ma:"A", sc:"A++", so:"A++", wr:"5"}},
    ];

    const schoolData = [
        {name:"å½°å¥³/å½°ä¸­", score:118, icon:"ğŸ‘‘"}, {name:"å½°å·¥å•†/å·¥", score:116, icon:"ğŸŒŸ"}, 
        {name:"å“¡æ—é«˜ä¸­", score:114.5, icon:"âœ¨"}, {name:"æºªæ¹–é«˜ä¸­", score:112, icon:"â­ï¸"}, 
        {name:"æˆåŠŸé«˜ä¸­", score:104, icon:"ğŸ†"}, {name:"é–€æª»æ ¡ç³»", score:90, icon:"ğŸ›¡ï¸"}
    ];

    const pointMap = {"A++":9, "A+":8, "A":7, "B++":6, "B+":5, "B":4, "C":3};
    const subName = {ch:"åœ‹æ–‡", en:"è‹±æ–‡", ma:"æ•¸å­¸", sc:"è‡ªç„¶", so:"ç¤¾æœƒ", wr:"å¯«ä½œ"};
    const subOrder = ["ch", "en", "ma", "sc", "so", "wr"];
    const colors = {ch:'#4ade80', en:'#22d3ee', ma:'#fbbf24', sc:'#f87171', so:'#a855f7', wr:'#8b5cf6'};
    let currentUser = null;
    let myRadar = null;
    let trendChart = null;

    window.onload = () => {
        const sel = document.getElementById('userSelect');
        db.forEach(u => sel.add(new Option(`åº§è™Ÿ ${u.id.toString().padStart(2,'0')} - ${u.name}`, u.id)));
        
        const cramBody = document.getElementById('cramSetupBody');
        subOrder.slice(0,5).forEach(k => {
            let tr = `<tr><td style="color:var(--gold); font-weight:bold;">${subName[k]}</td>`;
            for(let d=1; d<=6; d++) tr += `<td><input type="checkbox" class="cram-day" data-sub="${k}" data-day="${d}" style="width:18px; height:18px;"></td>`;
            cramBody.innerHTML += tr + `</tr>`;
        });

        const gIn = document.getElementById('gradeInputs');
        subOrder.forEach(k => {
            let html = `<div><small style="color:var(--accent); font-weight:bold;">${subName[k]}</small><select id="in_${k}">`;
            let opts = (k === "wr") ? ["6","5","4","3","2","1"] : ["A++","A+","A","B++","B+","B","C"];
            opts.forEach(v => html += `<option value="${v}">${v}</option>`);
            gIn.innerHTML += html + `</select></div>`;
        });
    };

    function handleLogin() {
        const id = document.getElementById('userSelect').value;
        const pass = document.getElementById('userPass').value;
        if(!id) return alert("è«‹é¸æ“‡åº§è™Ÿ");
        
        if(heroKeys[id] === pass) {
            currentUser = JSON.parse(JSON.stringify(db.find(u => u.id == id)));
            document.getElementById('loginWrapper').style.display = 'none';
            document.getElementById('reportSection').style.display = 'block';
            updateDashboard();
            resetInputsToCurrent();
        } else {
            alert("è‹±é›„é‡‘é‘°éŒ¯èª¤ï¼è«‹æ´½ç›Ÿä¸»ã€‚");
        }
    }

    function resetInputsToCurrent() {
        if(!currentUser) return;
        const original = db.find(u => u.id == currentUser.id);
        subOrder.forEach(k => {
            const defaultValue = original.g[k];
            document.getElementById('in_'+k).value = defaultValue;
            currentUser.g[k] = defaultValue;
        });
        document.getElementById('in_distRank').value = original.x;
        currentUser.x = original.x;
        updateDashboard();
    }

    function updateDashboard() {
        const basePoint = subOrder.slice(0,5).reduce((s, k) => s + pointMap[currentUser.g[k]], 0);
        const total = basePoint + 90;
        
        document.getElementById('displayName').innerText = currentUser.name;
        document.getElementById('xpLabel').innerText = `${basePoint} / 45`;
        document.getElementById('xpBarFill').style.width = (basePoint/45*100) + "%";
        document.getElementById('finalScoreLabel').innerText = `ç›®å‰ç¸½æˆ°åŠ›ï¼š${total}`;

        document.getElementById('val_v').innerHTML = `${currentUser.v}<span class="rank-unit">å</span>`;
        document.getElementById('val_y').innerHTML = `${currentUser.w}<span class="rank-unit">å</span>`;
        document.getElementById('val_ab').innerHTML = `${currentUser.x}<span class="rank-unit">å</span>`;

        const ranks = [
            {m: 45, t: "ç’€ç’¨å‚³èªª", e: "ğŸ‘‘"}, 
            {m: 40, t: "è‡³é«˜æˆ°ç¥", e: "ğŸ”¥"}, 
            {m: 35, t: "è¶…å‡¡å¤§å¸«", e: "ğŸ‹ğŸ¼â€â™‚ï¸"}, 
            {m: 31, t: "ç’€ç’¨é‘½çŸ³", e: "ğŸ’"}, 
            {m: 27, t: "å …å¯¦é‰‘é‡‘", e: "ğŸ†"}, 
            {m: 23, t: "æ¦®è€€é»ƒé‡‘", e: "ğŸŒŸ"}, 
            {m: 19, t: "æ˜Ÿè€€ç™½éŠ€", e: "âš”ï¸"}, 
            {m: 15, t: "è‹±å‹‡é’éŠ…", e: "ğŸ›¡ï¸"}, 
            {m: 8,  t: "å …éŸŒæˆ°å£«", e: "ğŸ§™ğŸ¼â€â™‚ï¸"}, 
            {m: 0,  t: "ä¸å±ˆåˆå¿ƒè€…", e: "ğŸŒ±"}
        ];
        
        // æ‰¾å‡ºç›®å‰çš„ç­‰ç´šç´¢å¼•
        const currentRankIdx = ranks.findIndex(x => basePoint >= x.m);
        const r = ranks[currentRankIdx] || ranks[ranks.length-1];
        document.getElementById('heroRank').innerText = r.t;
        document.getElementById('heroEmoji').innerText = r.e;

        // è¨ˆç®—ä¸¦é¡¯ç¤ºç´šåˆ†å·®è·
        let gapHtml = "";
        if (currentRankIdx > 0) {
            const nextRank = ranks[currentRankIdx - 1];
            const toNext = nextRank.m - basePoint;
            gapHtml += `<span style="color:#94a3b8">è·é›¢ã€${nextRank.t}ã€‘é‚„å·® </span><b style="color:var(--accent)">${toNext}</b><span style="color:#94a3b8"> ç´šåˆ†</span>`;
        } else {
            gapHtml += `<b style="color:var(--gold)">âœ¨ å‚³èªªå·”å³°ï¼šå·²é”æœ€é«˜éšç´š âœ¨</b>`;
        }
        
        const floorGap = basePoint - r.m;
        if (floorGap > 0) {
            gapHtml += `<br><small style="color:#64748b">å·²è¶…è¶Šã€${r.t}ã€‘é–€æª» ${floorGap} ç´šåˆ†</small>`;
        } else if (currentRankIdx < ranks.length - 1) {
            gapHtml += `<br><small style="color:var(--success)">ç©©å®šå®ˆä½ã€${r.t}ã€‘ç¨±è™Ÿä¸­</small>`;
        }

        document.getElementById('rankGapInfo').innerHTML = gapHtml;

        document.getElementById('gradeBadges').innerHTML = subOrder.map(k => `
            <div class="g-badge" style="background:rgba(255,255,255,0.05); padding: 5px 12px; border-radius:10px; border:1px solid ${colors[k]}">
                ${subName[k]}: <span style="color:var(--gold)">${currentUser.g[k]}</span>
            </div>
        `).join('');

        const targets = schoolData.filter(s => s.score <= total).sort((a,b)=>b.score - a.score).slice(0,3);
        document.getElementById('targetList').innerHTML = targets.map(t => `
            <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; border-left:4px solid var(--gold); margin-bottom:8px; display:flex; justify-content:space-between;">
                <span>${t.icon} ${t.name}</span> <span style="color:var(--gold); font-weight:900;">é–€æª» ${t.score}</span>
            </div>
        `).join('');

        renderRadarChart();
        renderTrendChart();
        renderHistoryList();
        generateWeeklySchedule();
    }

    function saveCurrentRecord() {
        const history = JSON.parse(localStorage.getItem(`hero_history_${currentUser.id}`)) || [];
        const currentInputs = {};
        subOrder.forEach(k => { currentInputs[k] = document.getElementById('in_'+k).value; });
        const currentDistRank = parseInt(document.getElementById('in_distRank').value);

        const basePoint = subOrder.slice(0,5).reduce((s, k) => s + pointMap[currentInputs[k]], 0);
        const newRecord = {
            date: new Date().toLocaleDateString(),
            xp: basePoint, total: basePoint + 90, grades: currentInputs,
            x: currentDistRank
        };
        history.push(newRecord);
        localStorage.setItem(`hero_history_${currentUser.id}`, JSON.stringify(history));
        currentUser.g = currentInputs;
        currentUser.x = currentDistRank;
        alert("æˆ°å ±å·²å­˜æª”ï¼");
        updateDashboard();
    }

    function renderTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const history = JSON.parse(localStorage.getItem(`hero_history_${currentUser.id}`)) || [];
        const originalDBData = db.find(u => u.id == currentUser.id);

        const firstPoint = { grades: originalDBData.g, x: originalDBData.x };
        const historyPoints = history;
        const currentPreviewGrades = {};
        subOrder.forEach(k => { currentPreviewGrades[k] = document.getElementById('in_'+k).value; });
        const currentDistRank = parseInt(document.getElementById('in_distRank').value) || 0;
        const previewPoint = { grades: currentPreviewGrades, x: currentDistRank };

        const records = [firstPoint, ...historyPoints, previewPoint];
        const labels = records.map((h, i) => {
            if (i === 0) return "ç¬¬1æ¬¡(åˆå§‹)";
            if (i === records.length - 1) return "æœ¬æ¬¡é è¦½";
            return `ç¬¬${i+1}æ¬¡`;
        });

        const datasets = subOrder.map(k => {
            return {
                label: subName[k],
                data: records.map(h => {
                    const grade = h.grades[k];
                    return k === 'wr' ? parseInt(grade) : pointMap[grade];
                }),
                borderColor: colors[k],
                backgroundColor: colors[k] + '33',
                borderWidth: 2, tension: 0.3,
                pointRadius: (context) => (context.dataIndex === records.length - 1 ? 6 : 4),
                pointStyle: (context) => (context.dataIndex === records.length - 1 ? 'rectRot' : 'circle'),
                fill: false,
                yAxisID: 'y'
            };
        });

        datasets.push({
            label: "å€æ’ (å³è»¸)",
            data: records.map(h => h.x),
            borderColor: '#94a3b8',
            borderDash: [5, 5],
            borderWidth: 2,
            tension: 0.3,
            fill: false,
            yAxisID: 'yRank',
            pointRadius: 4,
            pointBackgroundColor: '#94a3b8'
        });

        if(trendChart) trendChart.destroy();
        trendChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0, max: 10, 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#fff', stepSize: 1 } 
                    },
                    yRank: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        reverse: true,
                        grid: { drawOnChartArea: false },
                        ticks: { color: '#94a3b8' },
                        title: { display: true, text: 'å€æ’åæ¬¡', color: '#94a3b8' }
                    },
                    x: { ticks: { color: '#fff' } }
                },
                plugins: { legend: { display: true, position: 'top', labels: { color: '#fff', boxWidth: 10, font: { size: 10 } } } }
            }
        });
    }

    function renderHistoryList() {
        const history = JSON.parse(localStorage.getItem(`hero_history_${currentUser.id}`)) || [];
        const container = document.getElementById('historyList');
        if(!history.length) {
            container.innerHTML = "<p style='color:#64748b; text-align:center;'>å°šæœªæœ‰é¡å¤–å­˜æª”ç´€éŒ„</p>";
            return;
        }
        container.innerHTML = history.map((h, i) => `
            <div class="history-item" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05);">
                <div>
                    <span style="color:var(--accent); font-weight:bold;">#${i+2}</span> 
                    <small style="color:#64748b; margin-left:8px;">${h.date}</small>
                    <div style="font-weight:900; color:var(--gold); margin-top:4px;">æˆ°åŠ›ç´šåˆ†: ${h.xp} | å€æ’: ${h.x}</div>
                </div>
                <button onclick="deleteHistory(${i})" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:1.2rem;">ğŸ—‘ï¸</button>
            </div>
        `).join('');
    }

    function syncAndAnalyze() { 
        subOrder.forEach(k => { currentUser.g[k] = document.getElementById('in_'+k).value; }); 
        currentUser.x = parseInt(document.getElementById('in_distRank').value) || 0;
        updateDashboard(); 
    }

    function adminResetPrompt() {
        const adminPass = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡é‡‘é‘°ï¼š");
        if(adminPass === heroKeys["admin"]) {
            alert("ç³»çµ±ç¶­è­·æ¨¡å¼å·²é–‹å•Ÿã€‚");
        }
    }

    function deleteHistory(index) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æˆ°å ±å—ï¼Ÿ")) return;
        const history = JSON.parse(localStorage.getItem(`hero_history_${currentUser.id}`)) || [];
        history.splice(index, 1);
        localStorage.setItem(`hero_history_${currentUser.id}`, JSON.stringify(history));
        updateDashboard();
    }

    function clearAllHistory() {
        if(!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤è©²å¸³è™Ÿçš„æ‰€æœ‰æˆ°å ±å—ï¼Ÿ")) return;
        localStorage.removeItem(`hero_history_${currentUser.id}`);
        updateDashboard();
    }

    function renderRadarChart() {
        const ctx = document.getElementById('radarChart').getContext('2d');
        const subs5 = subOrder.slice(0,5);
        const vals = subs5.map(k => pointMap[currentUser.g[k]] * 10 + 10);
        if(myRadar) myRadar.destroy();
        myRadar = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['åœ‹', 'è‹±', 'æ•¸', 'è‡ª', 'ç¤¾'],
                datasets: [{ data: vals, backgroundColor: 'rgba(34, 211, 238, 0.2)', borderColor: '#22d3ee', borderWidth: 2 }]
            },
            options: { 
                maintainAspectRatio: false,
                scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#fff', font: { weight: 'bold' } } } },
                plugins: { legend: { display: false } }
            }
        });
        let sorted = [...subs5].sort((a,b)=>pointMap[currentUser.g[b]] - pointMap[currentUser.g[a]]);
        document.getElementById('strengthBox').innerHTML = `<b style="color:var(--success)">ğŸŒŸ å„ªå‹¢ï¼š${subName[sorted[0]]}</b><br>æ ¸å¿ƒæˆ°åŠ›ï¼Œç¹¼çºŒä¿æŒã€‚`;
        document.getElementById('weaknessBox').innerHTML = `<b style="color:var(--danger)">ğŸ› ï¸ åŠ å¼·ï¼š${subName[sorted[4]]}</b><br>ç©åˆ†å¢é•·é—œéµã€‚`;
    }

    function generateWeeklySchedule() {
        const body = document.getElementById('weeklyBody'); body.innerHTML = "";
        const crams = Array.from(document.querySelectorAll('.cram-day:checked')).map(i => ({sub: i.dataset.sub, day: i.dataset.day}));
        let weakK = subOrder.slice(0,5).sort((a,b)=>pointMap[currentUser.g[a]] - pointMap[currentUser.g[b]])[0];
        const times = ["19:30-21:00", "21:10-22:30"];
        times.forEach((t, idx) => {
            let tr = `<tr><td style="color:var(--accent); font-weight:bold;">${t}</td>`;
            for(let d=1; d<=7; d++) {
                if(d===7) { tr += `<td>å…¨ç§‘è¤‡ç¿’</td>`; continue; }
                const c = crams.find(x => x.day == d);
                if(idx === 0) {
                    tr += c ? `<td class="cram-active" style="color: var(--gold); font-weight: 900; border: 1.5px solid var(--gold) !important; border-radius: 8px;">è£œ:${subName[c.sub]}</td>` : `<td style="color:${colors[weakK]}; font-weight:bold;">${subName[weakK]}</td>`;
                } else {
                    const pool = subOrder.slice(0,5);
                    const randomSub = pool[Math.floor(Math.random() * pool.length)];
                    tr += `<td style="color:${colors[randomSub]}">${subName[randomSub]}</td>`;
                }
            }
            body.innerHTML += tr + "</tr>";
        });
    }
</script>
</body>
</html>